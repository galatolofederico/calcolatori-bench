{
  "passed": false,
  "output": [],
  "expected": [
    "TEST 1 PROC 5: OK",
    "TEST 2 PROC 5: OK",
    "TEST 3 PROC 5: ok",
    "TEST 4 PROC 5: ok",
    "Premere un tasto per continuare"
  ],
  "boot_output": "\u001bc\u001b[?7l\u001b[2J\u001b[0mSeaBIOS (version rel-1.16.3-0-ga6ed6b701f0a-prebuilt.qemu.org)\n\t\t\nBooting from ROM..INF\t-\tBoot loader di Calcolatori Elettronici, v1.0\nINF\t-\tMemoria totale: 32 MiB, heap: 636 KiB\nINF\t-\tArgomenti: /home/vscode//CE/lib/ce/boot.bin \nINF\t-\tIl boot loader precedente ha caricato 3 moduli:\nINF\t-\t- mod[0]: start=10c000 end=116b40 file=boot/0-sistema\nINF\t-\t  . seg[1]: off      0 vaddr           200000 size   6ad6 memsize   6ad6\nINF\t-\t  . seg[2]: off   7000 vaddr           207000 size   2fec memsize   2fec\nINF\t-\t  . seg[3]: off   a000 vaddr           20a000 size    180 memsize  17404\nINF\t-\t- mod[1]: start=117000 end=11d578 file=boot/1-io\nINF\t-\t  . seg[1]: off      0 vaddr      10000000000 size   3b29 memsize   3b29\nINF\t-\t  . seg[2]: off   4000 vaddr      10000004000 size   19bc memsize   19bc\nINF\t-\t  . seg[3]: off   6000 vaddr      10000006000 size    190 memsize    200\nINF\t-\t- mod[2]: start=11e000 end=127638 file=boot/2-utente\nINF\t-\t  . seg[1]: off      0 vaddr ffff800000000000 size   28d4 memsize   28d4\nINF\t-\t  . seg[2]: off   3000 vaddr ffff800000003000 size   52cc memsize   52cc\nINF\t-\t  . seg[3]: off   9000 vaddr ffff800000009000 size    248 memsize  1c380\nINF\t-\tCopio mod[0] agli indirizzi specificati nel file ELF:\nINF\t-\t- copiati   6ad6 byte da   10c000 a   200000\nINF\t-\t- copiati   2fec byte da   113000 a   207000\nINF\t-\t- copiati    180 byte da   116000 a   20a000\nINF\t-\t- azzerati ulteriori 17284 byte\nINF\t-\t- entry point 2058fb\nINF\t-\tCreata finestra sulla memoria centrale:  [            1000,          2000000)\nINF\t-\tCreata finestra per memory-mapped-IO:    [         2000000,        100000000)\nINF\t-\tInizializzo l'APIC\nINF\t-\tInizializzo video e tastiera\nINF\t-\tAttivo la modalita' a 64 bit e cedo il controllo a mod[0]...\nINF\t0\tNucleo di Calcolatori Elettronici, v8.3\nINF\t0\tNumero di frame: 546 (M1) 7646 (M2)\nINF\t0\tSuddivisione della memoria virtuale:\nINF\t0\t- sis/cond [               0,       8000000000)\nINF\t0\t- sis/priv [      8000000000,      10000000000)\nINF\t0\t- io /cond [     10000000000,      18000000000)\nINF\t0\t- usr/cond [ffff800000000000, ffffc00000000000)\nINF\t0\t- usr/priv [ffffc00000000000,                0)\nINF\t0\tCarico il modulo I/O\nINF\t0\t - segmento sistema read-only  mappato a [     10000000000,      10000004000)\nINF\t0\t - segmento sistema read-only  mappato a [     10000004000,      10000006000)\nINF\t0\t - segmento sistema read/write mappato a [     10000006000,      10000007000)\nINF\t0\t - heap:                                 [     10000007000,      10000107000)\nINF\t0\t - entry point: _start [io.s:17]\nINF\t0\tCarico il modulo utente\nINF\t0\t - segmento utente  read-only  mappato a [ffff800000000000, ffff800000003000)\nINF\t0\t - segmento utente  read-only  mappato a [ffff800000003000, ffff800000009000)\nINF\t0\t - segmento utente  read/write mappato a [ffff800000009000, ffff800000026000)\nINF\t0\t - heap:                                 [ffff800000026000, ffff800000126000)\nINF\t0\t - entry point: _start [utente.s:15]\nINF\t0\tFrame liberi: 7083 (M2)\nINF\t0\tHeap del modulo sistema: aggiunto [100000, 200000)\nINF\t0\tAttivo il timer (DELAY=59659)\nINF\t0\tCreo il processo main I/O\nINF\t0\tAttendo inizializzazione modulo I/O...\nINF\t1\tHeap del modulo I/O: 100000B [0x10000007000, 0x10000107000)\nINF\t1\tInizializzo la console (kbd + vid)\nINF\t1\testern=2 entry=estern_kbd(unsigned long) [io.cpp:197](0) prio=1104 (tipo=50) liv=0 irq=1\nINF\t1\tkbd: tastiera inizializzata\nINF\t1\tvid: video inizializzato\nINF\t1\tInizializzo la gestione dell'hard disk\nINF\t1\tbm: 00:01.1\nINF\t1\testern=3 entry=estern_hd(unsigned long) [io.cpp:557](0) prio=1120 (tipo=60) liv=0 irq=14\nINF\t1\tProcesso 1 terminato\nINF\t0\tCreo il processo main utente\nINF\t0\tCedo il controllo al processo main utente...\nINF\t4\tHeap del modulo utente: 100000B [0xffff800000025380, 0xffff800000125380)\nINF\t4\tproc=5 entry=main_body(unsigned long) [utente.cpp:384](0) prio=900 liv=3\nINF\t4\tProcesso 4 terminato\nDBG\t5\tTEST 0: >>>INIZIO<<<: errori vari\nINF\t5\tproc=6 entry=t00p0b(unsigned long) [utente.cpp:72](0) prio=600 liv=3\nINF\t5\tproc=7 entry=t00p1b(unsigned long) [utente.cpp:79](0) prio=599 liv=3\nINF\t5\tproc=8 entry=t00p2b(unsigned long) [utente.cpp:87](0) prio=598 liv=3\nINF\t5\tproc=9 entry=t00p3b(unsigned long) [utente.cpp:95](0) prio=597 liv=3\nINF\t5\tproc=10 entry=t00p4b(unsigned long) [utente.cpp:101](0) prio=596 liv=3\nINF\t5\tproc=11 entry=t00p5b(unsigned long) [utente.cpp:108](0) prio=595 liv=3\nWRN\t6\t  RIP=c_abort_p [sistema.cpp:1203] CPL=LIV_SISTEMA\nWRN\t6\t  RFLAGS=6 [-- -- -- -- -- -- -- -- PF --, IOPL=SISTEMA]\nWRN\t6\t  RAX=               6 RBX=            13a0 RCX=               0 RDX=ffffffd000000006\nWRN\t6\t  RDI=               2 RSI=ffff800000021340 RBP=      ffffffffa8 RSP=      ffffffffa0\nWRN\t6\t  R8 =               0 R9 =               0 R10=               0 R11=               0\nWRN\t6\t  R12=ffff800000021340 R13=               0 R14=               0 R15=               0\nWRN\t6\t  backtrace:\nWRN\t6\t  > c_swap_out [sistema.cpp:1890]\nWRN\t6\t  > a_swap_out [sistema.s:453]\nWRN\t6\t  > swap_out [utente.s:150]\nWRN\t6\t  > t00p0b(unsigned long) [utente.cpp:73 (discriminator 1)]\nWRN\t6\tProcesso 6 abortito\nWRN\t7\t  RIP=c_abort_p [sistema.cpp:1203] CPL=LIV_SISTEMA\nWRN\t7\t  RFLAGS=6 [-- -- -- -- -- -- -- -- PF --, IOPL=SISTEMA]\nWRN\t7\t  RAX=            16e0 RBX=            16e0 RCX=               0 RDX=            17b0\nWRN\t7\t  RDI=               2 RSI=              d0 RBP=      ffffffffa8 RSP=      ffffffffa0\nWRN\t7\t  R8 =               0 R9 =      fffffffdc7 R10=          207568 R11=          207568\nWRN\t7\t  R12=ffff800000021340 R13=               0 R14=               0 R15=               0\nWRN\t7\t  backtrace:\nWRN\t7\t  > c_swap_out [sistema.cpp:1894]\nWRN\t7\t  > a_swap_out [sistema.s:453]\nWRN\t7\t  > swap_out [utente.s:150]\nWRN\t7\t  > t00p0b(unsigned long) [utente.cpp:73 (discriminator 1)]\nWRN\t7\tProcesso 7 abortito\nWRN\t8\tEccezione 14 (page fault), errore 0, RIP c_swap_out [sistema.cpp:1896]\nWRN\t8\t  indirizzo virtuale: 98 (probabile puntatore NULL)\nWRN\t8\t  dettagli: pag o tab assente, lettura, da sistema, \nERR\t8\tPANIC: ERRORE DI SISTEMA\nERR\t8\t  processi: 5\nERR\t8\t------------------------------ PROCESSO IN ESECUZIONE -------------------------------\nERR\t8\tcorpo t00p2b(unsigned long) [utente.cpp:87](0), livello UTENTE, precedenza 598\nERR\t8\t  RIP=panic [sistema.cpp:1708] CPL=LIV_SISTEMA\nERR\t8\t  RFLAGS=2 [-- -- -- -- -- -- -- -- -- --, IOPL=SISTEMA]\nERR\t8\t  RAX=               a RBX=               0 RCX=               0 RDX=      ffffff03f8\nERR\t8\t  RDI=               3 RSI=             3f8 RBP=      ffffffff48 RSP=      ffffffff40\nERR\t8\t  R8 =              38 R9 =      fffffffd67 R10=          207568 R11=          207568\nERR\t8\t  R12=               e R13=          201544 R14=               0 R15=               0\nERR\t8\t  backtrace:\nERR\t8\t  > gestore_eccezioni [sistema.cpp:436]\nERR\t8\t  > exc_page_fault [sistema.s:847]\nERR\t8\t  > c_swap_out [sistema.cpp:1896]\nERR\t8\t  > a_swap_out [sistema.s:453]\nERR\t8\t  > swap_out [utente.s:150]\nERR\t8\t  > t00p0b(unsigned long) [utente.cpp:73 (discriminator 1)]\nERR\t8\t---------------------------------- ALTRI PROCESSI -----------------------------------\nERR\t8\tproc 0: corpo dummy(unsigned long) [sistema.cpp:1387](0), livello SISTEMA, precedenza 0\nERR\t8\t  RIP=main [sistema.cpp:1510] CPL=LIV_SISTEMA\nERR\t8\t  RFLAGS=6 [-- -- -- -- -- -- -- -- PF --, IOPL=SISTEMA]\nERR\t8\t  RAX=          20267d RBX=            13a0 RCX=               0 RDX=          2203f8\nERR\t8\t  RDI=            13a0 RSI=          221210 RBP=          2212e0 RSP=          221210\nERR\t8\t  R8 =              30 R9 =          22103f R10=               0 R11=               0\nERR\t8\t  R12=            13a0 R13=               0 R14=               0 R15=               0\nERR\t8\t  backtrace:\nERR\t8\t  > _start [start64.s:33]\nERR\t8\tproc 2: corpo estern_kbd(unsigned long) [io.cpp:197](0), livello SISTEMA, precedenza 1104\nERR\t8\t  RIP=estern_kbd(unsigned long) [io.cpp:197] CPL=LIV_SISTEMA\nERR\t8\t  RFLAGS=200 [-- -- -- IF -- -- -- -- -- --, IOPL=SISTEMA]\nERR\t8\t  RAX=               0 RBX=               0 RCX=               0 RDX=               0\nERR\t8\t  RDI=               0 RSI=               0 RBP=               0 RSP=      fffffffff8\nERR\t8\t  R8 =               0 R9 =               0 R10=               0 R11=               0\nERR\t8\t  R12=               0 R13=               0 R14=               0 R15=               0\nERR\t8\t  backtrace:\nERR\t8\tproc 3: corpo estern_hd(unsigned long) [io.cpp:557](0), livello SISTEMA, precedenza 1120\nERR\t8\t  RIP=estern_hd(unsigned long) [io.cpp:557] CPL=LIV_SISTEMA\nERR\t8\t  RFLAGS=200 [-- -- -- IF -- -- -- -- -- --, IOPL=SISTEMA]\nERR\t8\t  RAX=               0 RBX=               0 RCX=               0 RDX=               0\nERR\t8\t  RDI=               0 RSI=               0 RBP=               0 RSP=      fffffffff8\nERR\t8\t  R8 =               0 R9 =               0 R10=               0 R11=               0\nERR\t8\t  R12=               0 R13=               0 R14=               0 R15=               0\nERR\t8\t  backtrace:\nERR\t8\tproc 5: corpo main_body(unsigned long) [utente.cpp:384](0), livello UTENTE, precedenza 900\nERR\t8\t  RIP=delay [utente.s:63] CPL=LIV_UTENTE\nERR\t8\t  RFLAGS=206 [-- -- -- IF -- -- -- -- PF --, IOPL=SISTEMA]\nERR\t8\t  RAX=               b RBX=ffff800000025360 RCX=               3 RDX=ffff800000025344\nERR\t8\t  RDI=               1 RSI=               0 RBP=fffffffffffffff0 RSP=ffffffffffffffd8\nERR\t8\t  R8 =              69 R9 =fffffffffffffe99 R10=               0 R11=               0\nERR\t8\t  R12=ffff800000025368 R13=               0 R14=               0 R15=               0\nERR\t8\t  backtrace:\nERR\t8\t  > main_body(unsigned long) [utente.cpp:398]\nERR\t8\tproc 9: corpo t00p3b(unsigned long) [utente.cpp:95](0), livello UTENTE, precedenza 597\nERR\t8\t  RIP=t00p3b(unsigned long) [utente.cpp:95] CPL=LIV_UTENTE\nERR\t8\t  RFLAGS=200 [-- -- -- IF -- -- -- -- -- --, IOPL=SISTEMA]\nERR\t8\t  RAX=               0 RBX=               0 RCX=               0 RDX=               0\nERR\t8\t  RDI=               0 RSI=               0 RBP=               0 RSP=fffffffffffffff8\nERR\t8\t  R8 =               0 R9 =               0 R10=               0 R11=               0\nERR\t8\t  R12=               0 R13=               0 R14=               0 R15=               0\nERR\t8\t  backtrace:\nERR\t8\tproc 10: corpo t00p4b(unsigned long) [utente.cpp:101](0), livello UTENTE, precedenza 596\nERR\t8\t  RIP=t00p4b(unsigned long) [utente.cpp:101] CPL=LIV_UTENTE\nERR\t8\t  RFLAGS=200 [-- -- -- IF -- -- -- -- -- --, IOPL=SISTEMA]\nERR\t8\t  RAX=               0 RBX=               0 RCX=               0 RDX=               0\nERR\t8\t  RDI=               0 RSI=               0 RBP=               0 RSP=fffffffffffffff8\nERR\t8\t  R8 =               0 R9 =               0 R10=               0 R11=               0\nERR\t8\t  R12=               0 R13=               0 R14=               0 R15=               0\nERR\t8\t  backtrace:\nERR\t8\tproc 11: corpo t00p5b(unsigned long) [utente.cpp:108](0), livello UTENTE, precedenza 595\nERR\t8\t  RIP=t00p5b(unsigned long) [utente.cpp:108] CPL=LIV_UTENTE\nERR\t8\t  RFLAGS=200 [-- -- -- IF -- -- -- -- -- --, IOPL=SISTEMA]\nERR\t8\t  RAX=               0 RBX=               0 RCX=               0 RDX=               0\nERR\t8\t  RDI=               0 RSI=               0 RBP=               0 RSP=fffffffffffffff8\nERR\t8\t  R8 =               0 R9 =               0 R10=               0 R11=               0\nERR\t8\t  R12=               0 R13=               0 R14=               0 R15=               0\nERR\t8\t  backtrace:\n",
  "agent_output": "Performing one time database migration, may take a few minutes...\nsqlite-migration:done\nDatabase migration complete.\n\u001b[0m\n> build \u00b7 minimax/minimax-m2.5:nitro\n\u001b[0m\n\u001b[0m\u2731 \u001b[0mGlob \"**/*.cpp\"\u001b[90m 10 matches\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"ESAME|SOLUZIONE\"\u001b[90m 16 matches\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead sistema/sistema.cpp\u001b[90m [limit=20, offset=1850]\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead include/costanti.h\u001b[90m [limit=30, offset=40]\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"struct.*des_proc|class.*des_proc\"\u001b[90m 1 match\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead sistema/sistema.cpp\u001b[90m [limit=20, offset=920]\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead sistema/sistema.cpp\u001b[90m [limit=60, offset=24]\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"swap_out|swap_in\"\u001b[90m 48 matches\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"c_swap_out|c_swap_in\"\u001b[90m 4 matches\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"void c_swap|bool c_swap\"\u001b[90m 0 matches\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"^void c_|^bool c_\"\u001b[90m 0 matches\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"c_do_log|c_terminate_p\"\u001b[90m 6 matches\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"DIM_USR_STACK|usr_stack|pila.*utente\"\u001b[90m 33 matches\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"crea_pila|distruggi_pila\"\u001b[90m 11 matches\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead sistema/sistema.cpp\u001b[90m [limit=40, offset=855]\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"fin_utn_p|read_mem|write_mem\"\u001b[90m 7 matches\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead sistema/sistema.cpp\u001b[90m [limit=60, offset=1795]\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"schedula|schedul\"\u001b[90m 19 matches\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead sistema/sistema.cpp\u001b[90m [limit=30, offset=130]\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"getpid|execuzione-&gt;id\"\u001b[90m 5 matches\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead sistema/sistema.cpp\u001b[90m [limit=20, offset=1165]\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead sistema/sistema.s\u001b[90m [limit=30, offset=442]\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"activate_p.*natl|activate_pe.*natl\"\u001b[90m 4 matches\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"LIV_SISTEMA|livello.*SIS\"\u001b[90m 53 matches\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"proc_table\"\u001b[90m 7 matches\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead sistema/sistema.cpp\u001b[90m [limit=30, offset=790]\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead sistema/sistema.cpp\u001b[90m [limit=20, offset=75]\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead utente/utente.cpp\u001b[90m [limit=130, offset=1]\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead utente/utente.cpp\u001b[90m [limit=80, offset=130]\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead utente/utente.cpp\u001b[90m [limit=80, offset=300]\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"abort_p\\(|c_abort_p\"\u001b[90m 29 matches\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"^natq trasforma|^paddr trasforma\"\u001b[90m 0 matches\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"trasforma\\(\"\u001b[90m 13 matches\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"MAX_PROC_ID|MAX_PROC\"\u001b[90m 10 matches\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead sistema/sistema.cpp\u001b[90m [limit=25, offset=1]\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"liv_chiamante\"\u001b[90m 5 matches\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead sistema/sistema.cpp\u001b[90m [limit=10, offset=170]\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead sistema/sistema.cpp\u001b[90m [limit=15, offset=958]\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"void unmap\\(|void map\\(\"\u001b[90m 0 matches\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"extern.*unmap|extern.*map\"\u001b[90m 0 matches\u001b[0m\n\u001b[0m\u2731 \u001b[0mGlob \"include/*.h\"\u001b[90m 4 matches\u001b[0m\n\u001b[0m\u2731 \u001b[0mGlob \"**/*.h\"\u001b[90m 6 matches\u001b[0m\n\u001b[0m\u2731 \u001b[0mGlob \"**/boot.h\"\u001b[90m 0 matches\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"\\bmap\\s*\\(|\\bunmap\\s*\\(\"\u001b[90m 9 matches\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"#include.*libce\"\u001b[90m 6 matches\u001b[0m\n\u001b[0m\u2731 \u001b[0mGlob \"**/libce.h\"\u001b[90m 0 matches\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"DIM_USR_STACK.*KiB|KiB.*DIM_USR_STACK\"\u001b[90m 1 match\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"4*KiB|DIM_MISURA\"\u001b[90m 2 matches\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead include/costanti.h\u001b[90m [limit=30, offset=1]\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"#define KiB\"\u001b[90m 0 matches\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead sistema/sistema.cpp\u001b[90m [limit=20, offset=618]\u001b[0m\n\u001b[0m\n\u001b[0m\u2190 \u001b[0mEdit sistema/sistema.cpp\nIndex: /work/es2/nucleo/sistema/sistema.cpp\n===================================================================\n--- /work/es2/nucleo/sistema/sistema.cpp\n+++ /work/es2/nucleo/sistema/sistema.cpp\n@@ -1854,6 +1854,73 @@\n \n // ( SOLUZIONE 2025-06-05\n //   SOLUZIONE 2025-06-05 )\n \n+// Helper function to copy from a process's virtual memory\n+static void copy_from_proc(des_proc* p, vaddr src, void* dst, natq size)\n+{\n+\tfor (natq i = 0; i < size; i += DIM_PAGINA) {\n+\t\tpaddr pa = trasforma(p->cr3, src + i);\n+\t\tif (pa) {\n+\t\t\tmemcpy(static_cast<char*>(dst) + i, voidptr_cast(pa), DIM_PAGINA);\n+\t\t}\n+\t}\n+}\n \n+// Helper function to copy to a process's virtual memory\n+static void copy_to_proc(des_proc* p, vaddr dst, const void* src, natq size)\n+{\n+\tfor (natq i = 0; i < size; i += DIM_PAGINA) {\n+\t\tpaddr pa = trasforma(p->cr3, dst + i);\n+\t\tif (pa) {\n+\t\t\tmemcpy(voidptr_cast(pa), static_cast<const char*>(src) + i, DIM_PAGINA);\n+\t\t}\n+\t}\n+}\n+\n+extern \"C\" bool c_swap_out(natl pid, char* buf)\n+{\n+\tif (esecuzione->livello == LIV_SISTEMA) {\n+\t\tc_abort_p();\n+\t}\n+\tif (pid == esecuzione->id) {\n+\t\tc_abort_p();\n+\t}\n+\tif (pid > MAX_PROC_ID) {\n+\t\treturn false;\n+\t}\n+\tdes_proc* p = proc_table[pid];\n+\tif (p == nullptr || p->swapped_out) {\n+\t\treturn false;\n+\t}\n+\tcopy_from_proc(p, fin_utn_p - DIM_USR_STACK, buf, DIM_USR_STACK);\n+\tdistruggi_pila(p->cr3, fin_utn_p, DIM_USR_STACK);\n+\tp->swapped_out = true;\n+\treturn true;\n+}\n+\n+extern \"C\" bool c_swap_in(natl pid, const char* buf)\n+{\n+\tif (esecuzione->livello == LIV_SISTEMA) {\n+\t\tc_abort_p();\n+\t}\n+\tif (pid > MAX_PROC_ID) {\n+\t\treturn false;\n+\t}\n+\tdes_proc* p = proc_table[pid];\n+\tif (p == nullptr || !p->swapped_out) {\n+\t\treturn false;\n+\t}\n+\tif (!crea_pila(p->cr3, fin_utn_p, DIM_USR_STACK, LIV_UTENTE)) {\n+\t\treturn false;\n+\t}\n+\tcopy_to_proc(p, fin_utn_p - DIM_USR_STACK, buf, DIM_USR_STACK);\n+\tp->swapped_out = false;\n+\tif (p->scheduled) {\n+\t\tp->scheduled = false;\n+\t\tinserimento_lista(pronti, p);\n+\t}\n+\treturn true;\n+}\n+\n+\n /// @}\n\n\u001b[0m\n\u001b[0m$ \u001b[0mmake 2>&1 | head -50\n[compile] ==> Compilo  sistema/sistema.cpp\n[compile] ==> Assemblo sistema/sistema.s\n[compile] ==> Collego  debug/0-sistema [0x200000]\n[compile] ==> Genero   boot/0-sistema\n   [make] ==> Assemblo io/io.s\n   [make] ==> Compilo  io/io.cpp\n   [make] ==> Collego  debug/1-io      [0x10000000000]\n   [make] ==> Genero   boot/1-io\n   [make] ==> Assemblo utente/utente.s\n   [make] ==> Compilo  utente/lib.cpp\n   [make] ==> Compilo  utente/utente.cpp\n   [make] ==> Collego  debug/2-utente  [0xffff800000000000]\n   [make] ==> Genero   boot/2-utente\n\u001b[0m\n\u001b[0m$ \u001b[0mtimeout 10s boot 2>&1 | tail -50\nERR\t10\t  RIP=main [sistema.cpp:1510] CPL=LIV_SISTEMA\nERR\t10\t  RFLAGS=6 [-- -- -- -- -- -- -- -- PF --, IOPL=SISTEMA]\nERR\t10\t  RAX=          202663 RBX=            13a0 RCX=               0 RDX=          2203f8\nERR\t10\t  RDI=            13a0 RSI=          221210 RBP=          2212e0 RSP=          221210\nERR\t10\t  R8 =              30 R9 =          22103f R10=               0 R11=               0\nERR\t10\t  R12=            13a0 R13=               0 R14=               0 R15=               0\nERR\t10\t  backtrace:\nERR\t10\t  > _start [start64.s:33]\nERR\t10\tproc 2: corpo estern_kbd(unsigned long) [io.cpp:197](0), livello SISTEMA, precedenza 1104\nERR\t10\t  RIP=estern_kbd(unsigned long) [io.cpp:197] CPL=LIV_SISTEMA\nERR\t10\t  RFLAGS=200 [-- -- -- IF -- -- -- -- -- --, IOPL=SISTEMA]\nERR\t10\t  RAX=               0 RBX=               0 RCX=               0 RDX=               0\nERR\t10\t  RDI=               0 RSI=               0 RBP=               0 RSP=      fffffffff8\nERR\t10\t  R8 =               0 R9 =               0 R10=               0 R11=               0\nERR\t10\t  R12=               0 R13=               0 R14=               0 R15=               0\nERR\t10\t  backtrace:\nERR\t10\tproc 3: corpo estern_hd(unsigned long) [io.cpp:557](0), livello SISTEMA, precedenza 1120\nERR\t10\t  RIP=estern_hd(unsigned long) [io.cpp:557] CPL=LIV_SISTEMA\nERR\t10\t  RFLAGS=200 [-- -- -- IF -- -- -- -- -- --, IOPL=SISTEMA]\nERR\t10\t  RAX=               0 RBX=               0 RCX=               0 RDX=               0\nERR\t10\t  RDI=               0 RSI=               0 RBP=               0 RSP=      fffffffff8\nERR\t10\t  R8 =               0 R9 =               0 R10=               0 R11=               0\nERR\t10\t  R12=               0 R13=               0 R14=               0 R15=               0\nERR\t10\t  backtrace:\nERR\t10\tproc 5: corpo main_body(unsigned long) [utente.cpp:384](0), livello UTENTE, precedenza 900\nERR\t10\t  RIP=delay [utente.s:63] CPL=LIV_UTENTE\nERR\t10\t  RFLAGS=206 [-- -- -- IF -- -- -- -- PF --, IOPL=SISTEMA]\nERR\t10\t  RAX=               b RBX=ffff800000025360 RCX=               3 RDX=ffff800000025344\nERR\t10\t  RDI=               1 RSI=               0 RBP=fffffffffffffff0 RSP=ffffffffffffffd8\nERR\t10\t  R8 =              69 R9 =fffffffffffffe99 R10=               0 R11=               0\nERR\t10\t  R12=ffff800000025368 R13=               0 R14=               0 R15=               0\nERR\t10\t  backtrace:\nERR\t10\t  > main_body(unsigned long) [utente.cpp:398]\nERR\t10\tproc 9: corpo t00p3b(unsigned long) [utente.cpp:95](0), livello UTENTE, precedenza 597\nERR\t10\t  RIP=sem_wait [utente.s:49] CPL=LIV_UTENTE\nERR\t10\t  RFLAGS=202 [-- -- -- IF -- -- -- -- -- --, IOPL=SISTEMA]\nERR\t10\t  RAX=ffff800000025340 RBX=               0 RCX=               0 RDX=               0\nERR\t10\t  RDI=               2 RSI=               0 RBP=fffffffffffffff0 RSP=ffffffffffffffe8\nERR\t10\t  R8 =               0 R9 =               0 R10=               0 R11=               0\nERR\t10\t  R12=               0 R13=               0 R14=               0 R15=               0\nERR\t10\t  backtrace:\nERR\t10\t  > t00p3b(unsigned long) [utente.cpp:96]\nERR\t10\tproc 11: corpo t00p5b(unsigned long) [utente.cpp:108](0), livello UTENTE, precedenza 595\nERR\t10\t  RIP=t00p5b(unsigned long) [utente.cpp:108] CPL=LIV_UTENTE\nERR\t10\t  RFLAGS=200 [-- -- -- IF -- -- -- -- -- --, IOPL=SISTEMA]\nERR\t10\t  RAX=               0 RBX=               0 RCX=               0 RDX=               0\nERR\t10\t  RDI=               0 RSI=               0 RBP=               0 RSP=fffffffffffffff8\nERR\t10\t  R8 =               0 R9 =               0 R10=               0 R11=               0\nERR\t10\t  R12=               0 R13=               0 R14=               0 R15=               0\nERR\t10\t  backtrace:\n\u001b[0m\n\u001b[0m$ \u001b[0mtimeout 10s boot 2>&1 | grep \"^USR\"\nUSR\t7\tTEST 0 PROC 7: ERRORE: swap_out() o swap_in() su processo di sistema non ha causato abort\nUSR\t8\tTEST 0 PROC 8: ERRORE: swap_out() o swap_in() su pid non valido non ha causato abort\n\u001b[0m\n\u001b[0m\u2190 \u001b[0mEdit sistema/sistema.cpp\nIndex: /work/es2/nucleo/sistema/sistema.cpp\n===================================================================\n--- /work/es2/nucleo/sistema/sistema.cpp\n+++ /work/es2/nucleo/sistema/sistema.cpp\n@@ -1885,12 +1885,15 @@\n if (pid == esecuzione->id) {\n \tc_abort_p();\n }\n if (pid > MAX_PROC_ID) {\n-\treturn false;\n+\tc_abort_p();\n }\n des_proc* p = proc_table[pid];\n-if (p == nullptr || p->swapped_out) {\n+if (p == nullptr) {\n+\tc_abort_p();\n+}\n+if (p->swapped_out) {\n \treturn false;\n }\n copy_from_proc(p, fin_utn_p - DIM_USR_STACK, buf, DIM_USR_STACK);\n distruggi_pila(p->cr3, fin_utn_p, DIM_USR_STACK);\n@@ -1903,12 +1906,15 @@\n if (esecuzione->livello == LIV_SISTEMA) {\n \tc_abort_p();\n }\n if (pid > MAX_PROC_ID) {\n-\treturn false;\n+\tc_abort_p();\n }\n des_proc* p = proc_table[pid];\n-if (p == nullptr || !p->swapped_out) {\n+if (p == nullptr) {\n+\tc_abort_p();\n+}\n+if (!p->swapped_out) {\n \treturn false;\n }\n if (!crea_pila(p->cr3, fin_utn_p, DIM_USR_STACK, LIV_UTENTE)) {\n \treturn false;\n\n\u001b[0m\n\u001b[0m$ \u001b[0mmake 2>&1 | head -20\n[compile] ==> Compilo  sistema/sistema.cpp\n[compile] ==> Assemblo sistema/sistema.s\n[compile] ==> Collego  debug/0-sistema [0x200000]\n[compile] ==> Genero   boot/0-sistema\n\u001b[0m\n\u001b[0m$ \u001b[0mtimeout 10s boot 2>&1 | grep \"^USR\"\n\u001b[0m\n\u001b[0m$ \u001b[0mtimeout 10s boot 2>&1 | grep -E \"^USR|ERRORE|panic|error\"\nDBG\t5\tTEST 0: >>>INIZIO<<<: errori vari\nWRN\t8\tEccezione 14 (page fault), errore 0, RIP c_swap_out [sistema.cpp:1895]\nERR\t8\tPANIC: ERRORE DI SISTEMA\nERR\t8\t  RIP=panic [sistema.cpp:1708] CPL=LIV_SISTEMA\n\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"DIM_PAGINA\"\u001b[90m 28 matches\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead sistema/sistema.s\u001b[90m [limit=20, offset=445]\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"salva_stato:\"\u001b[90m 1 match\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead sistema/sistema.s\u001b[90m [limit=40, offset=41]\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead sistema/sistema.s\u001b[90m [limit=30, offset=80]\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead utente/lib.cpp\u001b[90m [limit=20, offset=45]\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead sistema/sistema.cpp\u001b[90m [limit=30, offset=1190]\u001b[0m\n\u001b[0m\n\u001b[0m$ \u001b[0mtimeout 10s boot 2>&1 | grep -v \"^DBG\\|^WRN\\|^ERR\\|backtrace\\|^\tproc\\|RIP=\\|RAX=\\|RDI=\\|RBP=\\|RSP=\" | head -30\n\u001bc\u001b[?7l\u001b[2J\u001b[0mSeaBIOS (version rel-1.16.3-0-ga6ed6b701f0a-prebuilt.qemu.org)\n\t\t\nBooting from ROM..INF\t-\tBoot loader di Calcolatori Elettronici, v1.0\nINF\t-\tMemoria totale: 32 MiB, heap: 636 KiB\nINF\t-\tArgomenti: /home/vscode//CE/lib/ce/boot.bin \nINF\t-\tIl boot loader precedente ha caricato 3 moduli:\nINF\t-\t- mod[0]: start=10c000 end=116b40 file=boot/0-sistema\nINF\t-\t  . seg[1]: off      0 vaddr           200000 size   6ac6 memsize   6ac6\nINF\t-\t  . seg[2]: off   7000 vaddr           207000 size   2fec memsize   2fec\nINF\t-\t  . seg[3]: off   a000 vaddr           20a000 size    180 memsize  17404\nINF\t-\t- mod[1]: start=117000 end=11d578 file=boot/1-io\nINF\t-\t  . seg[1]: off      0 vaddr      10000000000 size   3b29 memsize   3b29\nINF\t-\t  . seg[2]: off   4000 vaddr      10000004000 size   19bc memsize   19bc\nINF\t-\t  . seg[3]: off   6000 vaddr      10000006000 size    190 memsize    200\nINF\t-\t- mod[2]: start=11e000 end=127638 file=boot/2-utente\nINF\t-\t  . seg[1]: off      0 vaddr ffff800000000000 size   28d4 memsize   28d4\nINF\t-\t  . seg[2]: off   3000 vaddr ffff800000003000 size   52cc memsize   52cc\nINF\t-\t  . seg[3]: off   9000 vaddr ffff800000009000 size    248 memsize  1c380\nINF\t-\tCopio mod[0] agli indirizzi specificati nel file ELF:\nINF\t-\t- copiati   6ac6 byte da   10c000 a   200000\nINF\t-\t- copiati   2fec byte da   113000 a   207000\nINF\t-\t- copiati    180 byte da   116000 a   20a000\nINF\t-\t- azzerati ulteriori 17284 byte\nINF\t-\t- entry point 2058eb\nINF\t-\tCreata finestra sulla memoria centrale:  [            1000,          2000000)\nINF\t-\tCreata finestra per memory-mapped-IO:    [         2000000,        100000000)\nINF\t-\tInizializzo l'APIC\nINF\t-\tInizializzo video e tastiera\nINF\t-\tAttivo la modalita' a 64 bit e cedo il controllo a mod[0]...\nINF\t0\tNucleo di Calcolatori Elettronici, v8.3\nINF\t0\tNumero di frame: 546 (M1) 7646 (M2)\n\u001b[0m\n\u001b[0m$ \u001b[0mtimeout 10s boot 2>&1 | grep -E \"USR|ERR|page fault|c_swap\" | head -20\nWRN\t6\t  > c_swap_out [sistema.cpp:1886]\nWRN\t7\t  > c_swap_out [sistema.cpp:1893]\nWRN\t8\tEccezione 14 (page fault), errore 0, RIP c_swap_out [sistema.cpp:1895]\nERR\t8\tPANIC: ERRORE DI SISTEMA\nERR\t8\t  processi: 5\nERR\t8\t------------------------------ PROCESSO IN ESECUZIONE -------------------------------\nERR\t8\tcorpo t00p2b(unsigned long) [utente.cpp:87](0), livello UTENTE, precedenza 598\nERR\t8\t  RIP=panic [sistema.cpp:1708] CPL=LIV_SISTEMA\nERR\t8\t  RFLAGS=2 [-- -- -- -- -- -- -- -- -- --, IOPL=SISTEMA]\nERR\t8\t  RAX=               a RBX=               0 RCX=               0 RDX=      ffffff03f8\nERR\t8\t  RDI=               3 RSI=             3f8 RBP=      ffffffff48 RSP=      ffffffff40\nERR\t8\t  R8 =              38 R9 =      fffffffd67 R10=          207568 R11=          207568\nERR\t8\t  R12=               e R13=          201534 R14=               0 R15=               0\nERR\t8\t  backtrace:\nERR\t8\t  > gestore_eccezioni [sistema.cpp:436]\nERR\t8\t  > exc_page_fault [sistema.s:847]\nERR\t8\t  > c_swap_out [sistema.cpp:1895]\nERR\t8\t  > a_swap_out [sistema.s:453]\nERR\t8\t  > swap_out [utente.s:150]\nERR\t8\t  > t00p0b(unsigned long) [utente.cpp:73 (discriminator 1)]\n\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"^des_proc\\* esecuzione\"\u001b[90m 2 matches\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead sistema/sistema.cpp\u001b[90m [limit=50, offset=1855]\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"void c_abort_p\"\u001b[90m 2 matches\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead utente/utente.cpp\u001b[90m [limit=20, offset=60]\u001b[0m\nLet me check how getpid() is implemented and what value it might be returning.\n\u001b[0m\u2192 \u001b[0mRead utente/utente.cpp\u001b[90m [limit=40, offset=375]\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"getmeminfo\\(\"\u001b[90m 10 matches\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead sistema/sistema.cpp\u001b[90m [limit=20, offset=1770]\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"timer.*schedul|schedul.*timer\"\u001b[90m 0 matches\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"INTR_TIPO_TIMER\"\u001b[90m 3 matches\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"driver_td:\"\u001b[90m 1 match\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead sistema/sistema.s\u001b[90m [limit=25, offset=977]\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"^extern.*des_proc|des_proc\\*.*=\"\u001b[90m 10 matches\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"eschione\\s*=\"\u001b[90m 0 matches\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"esecuzione\\s*=\"\u001b[90m 2 matches\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead sistema/sistema.cpp\u001b[90m [limit=20, offset=130]\u001b[0m\n\u001b[0m\n\u001b[0m\u2190 \u001b[0mEdit sistema/sistema.cpp\nIndex: /work/es2/nucleo/sistema/sistema.cpp\n===================================================================\n--- /work/es2/nucleo/sistema/sistema.cpp\n+++ /work/es2/nucleo/sistema/sistema.cpp\n@@ -1878,19 +1878,24 @@\n }\n \n extern \"C\" bool c_swap_out(natl pid, char* buf)\n {\n+\tflog(LOG_DEBUG, \"c_swap_out: pid=%u, esecuzione->id=%u\", pid, esecuzione->id);\n \tif (esecuzione->livello == LIV_SISTEMA) {\n+\t\tflog(LOG_DEBUG, \"c_swap_out: aborting - system process\");\n \t\tc_abort_p();\n \t}\n \tif (pid == esecuzione->id) {\n+\t\tflog(LOG_DEBUG, \"c_swap_out: aborting - same process\");\n \t\tc_abort_p();\n \t}\n \tif (pid > MAX_PROC_ID) {\n+\t\tflog(LOG_DEBUG, \"c_swap_out: aborting - invalid pid\");\n \t\tc_abort_p();\n \t}\n \tdes_proc* p = proc_table[pid];\n \tif (p == nullptr) {\n+\t\tflog(LOG_DEBUG, \"c_swap_out: aborting - null process\");\n \t\tc_abort_p();\n \t}\n \tif (p->swapped_out) {\n \t\treturn false;\n\n\u001b[0m\n\u001b[0m$ \u001b[0mmake 2>&1 | head -10\n[compile] ==> Compilo  sistema/sistema.cpp\n[compile] ==> Assemblo sistema/sistema.s\n[compile] ==> Collego  debug/0-sistema [0x200000]\n[compile] ==> Genero   boot/0-sistema\n\u001b[0m\n\u001b[0m$ \u001b[0mtimeout 10s boot 2>&1 | grep -E \"c_swap_out|DBG.*TEST\"\nDBG\t5\tTEST 0: >>>INIZIO<<<: errori vari\nDBG\t6\tc_swap_out: pid=6, esecuzione->id=6\nDBG\t6\tc_swap_out: aborting - same process\nWRN\t6\t  > c_swap_out [sistema.cpp:1889]\nDBG\t7\tc_swap_out: aborting - null process\nWRN\t7\t  > c_swap_out [sistema.cpp:1898]\nWRN\t8\tEccezione 14 (page fault), errore 0, RIP c_swap_out [sistema.cpp:1900]\nERR\t8\t  > c_swap_out [sistema.cpp:1900]\n\u001b[0m\n\u001b[0m$ \u001b[0mtimeout 10s boot 2>&1 | grep -E \"^DBG.*c_swap|^WRN.*Eccezione\" | head -20\nDBG\t6\tc_swap_out: pid=6, esecuzione->id=6\nDBG\t6\tc_swap_out: aborting - same process\nDBG\t7\tc_swap_out: aborting - null process\nWRN\t8\tEccezione 14 (page fault), errore 0, RIP c_swap_out [sistema.cpp:1900]\n\u001b[0m\n\u001b[0m\u2190 \u001b[0mEdit sistema/sistema.cpp\nIndex: /work/es2/nucleo/sistema/sistema.cpp\n===================================================================\n--- /work/es2/nucleo/sistema/sistema.cpp\n+++ /work/es2/nucleo/sistema/sistema.cpp\n@@ -1878,24 +1878,19 @@\n }\n \n extern \"C\" bool c_swap_out(natl pid, char* buf)\n {\n-\tflog(LOG_DEBUG, \"c_swap_out: pid=%u, esecuzione->id=%u\", pid, esecuzione->id);\n+\tif (pid > MAX_PROC_ID) {\n+\t\tc_abort_p();\n+\t}\n \tif (esecuzione->livello == LIV_SISTEMA) {\n-\t\tflog(LOG_DEBUG, \"c_swap_out: aborting - system process\");\n \t\tc_abort_p();\n \t}\n \tif (pid == esecuzione->id) {\n-\t\tflog(LOG_DEBUG, \"c_swap_out: aborting - same process\");\n \t\tc_abort_p();\n \t}\n-\tif (pid > MAX_PROC_ID) {\n-\t\tflog(LOG_DEBUG, \"c_swap_out: aborting - invalid pid\");\n-\t\tc_abort_p();\n-\t}\n \tdes_proc* p = proc_table[pid];\n \tif (p == nullptr) {\n-\t\tflog(LOG_DEBUG, \"c_swap_out: aborting - null process\");\n \t\tc_abort_p();\n \t}\n \tif (p->swapped_out) {\n \t\treturn false;\n\n\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead sistema/sistema.cpp\u001b[90m [limit=30, offset=1895]\u001b[0m\n\u001b[0m\n\u001b[0m$ \u001b[0mmake 2>&1 | head -10\n[compile] ==> Compilo  sistema/sistema.cpp\n[compile] ==> Assemblo sistema/sistema.s\n[compile] ==> Collego  debug/0-sistema [0x200000]\n[compile] ==> Genero   boot/0-sistema\n\u001b[0m\n\u001b[0m$ \u001b[0mtimeout 10s boot 2>&1 | grep -E \"^USR|ERRORE|panic|error\"\nDBG\t5\tTEST 0: >>>INIZIO<<<: errori vari\nWRN\t8\tEccezione 14 (page fault), errore 0, RIP c_swap_out [sistema.cpp:1895]\nERR\t8\tPANIC: ERRORE DI SISTEMA\nERR\t8\t  RIP=panic [sistema.cpp:1708] CPL=LIV_SISTEMA\n\u001b[0m\n\u001b[0m$ \u001b[0mtimeout 10s boot 2>&1 | grep -E \"TEST|swap_out|swap_in|ERR\" | head -30\nDBG\t5\tTEST 0: >>>INIZIO<<<: errori vari\nWRN\t6\t  > c_swap_out [sistema.cpp:1889]\nWRN\t6\t  > a_swap_out [sistema.s:453]\nWRN\t6\t  > swap_out [utente.s:150]\nWRN\t7\t  > c_swap_out [sistema.cpp:1893]\nWRN\t7\t  > a_swap_out [sistema.s:453]\nWRN\t7\t  > swap_out [utente.s:150]\nWRN\t8\tEccezione 14 (page fault), errore 0, RIP c_swap_out [sistema.cpp:1895]\nERR\t8\tPANIC: ERRORE DI SISTEMA\nERR\t8\t  processi: 5\nERR\t8\t------------------------------ PROCESSO IN ESECUZIONE -------------------------------\nERR\t8\tcorpo t00p2b(unsigned long) [utente.cpp:87](0), livello UTENTE, precedenza 598\nERR\t8\t  RIP=panic [sistema.cpp:1708] CPL=LIV_SISTEMA\nERR\t8\t  RFLAGS=2 [-- -- -- -- -- -- -- -- -- --, IOPL=SISTEMA]\nERR\t8\t  RAX=               a RBX=               0 RCX=               0 RDX=      ffffff03f8\nERR\t8\t  RDI=               3 RSI=             3f8 RBP=      ffffffff48 RSP=      ffffffff40\nERR\t8\t  R8 =              38 R9 =      fffffffd67 R10=          207568 R11=          207568\nERR\t8\t  R12=               e R13=          201534 R14=               0 R15=               0\nERR\t8\t  backtrace:\nERR\t8\t  > gestore_eccezioni [sistema.cpp:436]\nERR\t8\t  > exc_page_fault [sistema.s:847]\nERR\t8\t  > c_swap_out [sistema.cpp:1895]\nERR\t8\t  > a_swap_out [sistema.s:453]\nERR\t8\t  > swap_out [utente.s:150]\nERR\t8\t  > t00p0b(unsigned long) [utente.cpp:73 (discriminator 1)]\nERR\t8\t---------------------------------- ALTRI PROCESSI -----------------------------------\nERR\t8\tproc 0: corpo dummy(unsigned long) [sistema.cpp:1387](0), livello SISTEMA, precedenza 0\nERR\t8\t  RIP=main [sistema.cpp:1510] CPL=LIV_SISTEMA\nERR\t8\t  RFLAGS=6 [-- -- -- -- -- -- -- -- PF --, IOPL=SISTEMA]\nERR\t8\t  RAX=          20266d RBX=            13a0 RCX=               0 RDX=          2203f8\n\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead sistema/sistema.cpp\u001b[90m [limit=15, offset=1888]\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead sistema/sistema.cpp\u001b[90m [limit=10, offset=965]\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead sistema/sistema.cpp\u001b[90m [limit=20, offset=855]\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead sistema/sistema.cpp\u001b[90m [limit=10, offset=958]\u001b[0m\n\u001b[0m\n\u001b[0m\u2190 \u001b[0mEdit sistema/sistema.cpp\nIndex: /work/es2/nucleo/sistema/sistema.cpp\n===================================================================\n--- /work/es2/nucleo/sistema/sistema.cpp\n+++ /work/es2/nucleo/sistema/sistema.cpp\n@@ -1857,8 +1857,9 @@\n \n // Helper function to copy from a process's virtual memory\n static void copy_from_proc(des_proc* p, vaddr src, void* dst, natq size)\n {\n+\tmemset(dst, 0, size);\n \tfor (natq i = 0; i < size; i += DIM_PAGINA) {\n \t\tpaddr pa = trasforma(p->cr3, src + i);\n \t\tif (pa) {\n \t\t\tmemcpy(static_cast<char*>(dst) + i, voidptr_cast(pa), DIM_PAGINA);\n\n\u001b[0m\n\u001b[0m$ \u001b[0mmake 2>&1 | head -10\n[compile] ==> Compilo  sistema/sistema.cpp\n[compile] ==> Assemblo sistema/sistema.s\n[compile] ==> Collego  debug/0-sistema [0x200000]\n[compile] ==> Genero   boot/0-sistema\n\u001b[0m\n\u001b[0m$ \u001b[0mtimeout 10s boot 2>&1 | grep -E \"^USR|ERRORE|panic|error\"\nDBG\t5\tTEST 0: >>>INIZIO<<<: errori vari\nWRN\t8\tEccezione 14 (page fault), errore 0, RIP c_swap_out [sistema.cpp:1896]\nERR\t8\tPANIC: ERRORE DI SISTEMA\nERR\t8\t  RIP=panic [sistema.cpp:1708] CPL=LIV_SISTEMA\n\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead sistema/sistema.cpp\u001b[90m [limit=10, offset=1858]\u001b[0m\n\u001b[0m\u2731 \u001b[0mGrep \"ini_utn_p|fin_utn_p\"\u001b[90m 10 matches\u001b[0m\n\u001b[0m\u2192 \u001b[0mRead sistema/sistema.cpp\u001b[90m [limit=20, offset=1890]\u001b[0m\n\u001b[93m\u001b[1m! \u001b[0m maximum turns of 100 reached, stopping session\n",
  "duration_seconds": 502.73,
  "turns": 100,
  "max_turns": 100,
  "diff": "diff --git a/sistema/sistema.cpp b/sistema/sistema.cpp\nindex 77b0c66..1e71351 100644\n--- a/sistema/sistema.cpp\n+++ b/sistema/sistema.cpp\n@@ -1855,5 +1855,79 @@ void process_dump(des_proc* p, log_sev sev)\n // ( SOLUZIONE 2025-06-05\n //   SOLUZIONE 2025-06-05 )\n \n+// Helper function to copy from a process's virtual memory\n+static void copy_from_proc(des_proc* p, vaddr src, void* dst, natq size)\n+{\n+\tmemset(dst, 0, size);\n+\tfor (natq i = 0; i < size; i += DIM_PAGINA) {\n+\t\tpaddr pa = trasforma(p->cr3, src + i);\n+\t\tif (pa) {\n+\t\t\tmemcpy(static_cast<char*>(dst) + i, voidptr_cast(pa), DIM_PAGINA);\n+\t\t}\n+\t}\n+}\n+\n+// Helper function to copy to a process's virtual memory\n+static void copy_to_proc(des_proc* p, vaddr dst, const void* src, natq size)\n+{\n+\tfor (natq i = 0; i < size; i += DIM_PAGINA) {\n+\t\tpaddr pa = trasforma(p->cr3, dst + i);\n+\t\tif (pa) {\n+\t\t\tmemcpy(voidptr_cast(pa), static_cast<const char*>(src) + i, DIM_PAGINA);\n+\t\t}\n+\t}\n+}\n+\n+extern \"C\" bool c_swap_out(natl pid, char* buf)\n+{\n+\tif (pid > MAX_PROC_ID) {\n+\t\tc_abort_p();\n+\t}\n+\tif (esecuzione->livello == LIV_SISTEMA) {\n+\t\tc_abort_p();\n+\t}\n+\tif (pid == esecuzione->id) {\n+\t\tc_abort_p();\n+\t}\n+\tdes_proc* p = proc_table[pid];\n+\tif (p == nullptr) {\n+\t\tc_abort_p();\n+\t}\n+\tif (p->swapped_out) {\n+\t\treturn false;\n+\t}\n+\tcopy_from_proc(p, fin_utn_p - DIM_USR_STACK, buf, DIM_USR_STACK);\n+\tdistruggi_pila(p->cr3, fin_utn_p, DIM_USR_STACK);\n+\tp->swapped_out = true;\n+\treturn true;\n+}\n+\n+extern \"C\" bool c_swap_in(natl pid, const char* buf)\n+{\n+\tif (esecuzione->livello == LIV_SISTEMA) {\n+\t\tc_abort_p();\n+\t}\n+\tif (pid > MAX_PROC_ID) {\n+\t\tc_abort_p();\n+\t}\n+\tdes_proc* p = proc_table[pid];\n+\tif (p == nullptr) {\n+\t\tc_abort_p();\n+\t}\n+\tif (!p->swapped_out) {\n+\t\treturn false;\n+\t}\n+\tif (!crea_pila(p->cr3, fin_utn_p, DIM_USR_STACK, LIV_UTENTE)) {\n+\t\treturn false;\n+\t}\n+\tcopy_to_proc(p, fin_utn_p - DIM_USR_STACK, buf, DIM_USR_STACK);\n+\tp->swapped_out = false;\n+\tif (p->scheduled) {\n+\t\tp->scheduled = false;\n+\t\tinserimento_lista(pronti, p);\n+\t}\n+\treturn true;\n+}\n+\n \n /// @}\ndiff --git a/sistema/sistema.cpp b/sistema/sistema.cpp\nindex 77b0c66..1e71351 100644\n--- a/sistema/sistema.cpp\n+++ b/sistema/sistema.cpp\n@@ -1855,5 +1855,79 @@ void process_dump(des_proc* p, log_sev sev)\n // ( SOLUZIONE 2025-06-05\n //   SOLUZIONE 2025-06-05 )\n \n+// Helper function to copy from a process's virtual memory\n+static void copy_from_proc(des_proc* p, vaddr src, void* dst, natq size)\n+{\n+\tmemset(dst, 0, size);\n+\tfor (natq i = 0; i < size; i += DIM_PAGINA) {\n+\t\tpaddr pa = trasforma(p->cr3, src + i);\n+\t\tif (pa) {\n+\t\t\tmemcpy(static_cast<char*>(dst) + i, voidptr_cast(pa), DIM_PAGINA);\n+\t\t}\n+\t}\n+}\n+\n+// Helper function to copy to a process's virtual memory\n+static void copy_to_proc(des_proc* p, vaddr dst, const void* src, natq size)\n+{\n+\tfor (natq i = 0; i < size; i += DIM_PAGINA) {\n+\t\tpaddr pa = trasforma(p->cr3, dst + i);\n+\t\tif (pa) {\n+\t\t\tmemcpy(voidptr_cast(pa), static_cast<const char*>(src) + i, DIM_PAGINA);\n+\t\t}\n+\t}\n+}\n+\n+extern \"C\" bool c_swap_out(natl pid, char* buf)\n+{\n+\tif (pid > MAX_PROC_ID) {\n+\t\tc_abort_p();\n+\t}\n+\tif (esecuzione->livello == LIV_SISTEMA) {\n+\t\tc_abort_p();\n+\t}\n+\tif (pid == esecuzione->id) {\n+\t\tc_abort_p();\n+\t}\n+\tdes_proc* p = proc_table[pid];\n+\tif (p == nullptr) {\n+\t\tc_abort_p();\n+\t}\n+\tif (p->swapped_out) {\n+\t\treturn false;\n+\t}\n+\tcopy_from_proc(p, fin_utn_p - DIM_USR_STACK, buf, DIM_USR_STACK);\n+\tdistruggi_pila(p->cr3, fin_utn_p, DIM_USR_STACK);\n+\tp->swapped_out = true;\n+\treturn true;\n+}\n+\n+extern \"C\" bool c_swap_in(natl pid, const char* buf)\n+{\n+\tif (esecuzione->livello == LIV_SISTEMA) {\n+\t\tc_abort_p();\n+\t}\n+\tif (pid > MAX_PROC_ID) {\n+\t\tc_abort_p();\n+\t}\n+\tdes_proc* p = proc_table[pid];\n+\tif (p == nullptr) {\n+\t\tc_abort_p();\n+\t}\n+\tif (!p->swapped_out) {\n+\t\treturn false;\n+\t}\n+\tif (!crea_pila(p->cr3, fin_utn_p, DIM_USR_STACK, LIV_UTENTE)) {\n+\t\treturn false;\n+\t}\n+\tcopy_to_proc(p, fin_utn_p - DIM_USR_STACK, buf, DIM_USR_STACK);\n+\tp->swapped_out = false;\n+\tif (p->scheduled) {\n+\t\tp->scheduled = false;\n+\t\tinserimento_lista(pronti, p);\n+\t}\n+\treturn true;\n+}\n+\n \n /// @}\n",
  "error": null
}